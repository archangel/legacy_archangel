var Archangel = (function(object) {

  var serialize = function(obj, prefix) {
        var p,
            str = [];

        for (p in obj) {
          if (obj.hasOwnProperty(p)) {
            var k = prefix ? prefix + "[" + p + "]" : p,
                v = obj[p];

            str.push((v !== null && typeof v === "object") ?
              serialize(v, k) :
              encodeURIComponent(k) + "=" + encodeURIComponent(v));
          }
        }

        return str.join("&");
      },
      pathBuilder = function(path) {
        var new_path = [];

        // Array to string
        if (path.constructor === Array) {
          new_path = path.map(function(segment) {
                       return encodeURIComponent(segment);
                     });
        // Object to string
        } else if (path.constructor === Object) {
          new_path = Object.keys(path).map(function(resource) {
                       return [
                         encodeURIComponent(resource),
                         encodeURIComponent(path[resource])
                       ].join("/");
                     });
        // String
        } else if (path.constructor === String) {
          new_path = [encodeURIComponent(path)];
        }

        final_path = new_path.filter(Boolean).join("/").toLowerCase();

        return final_path;
      };

  function mountScope() {
    var mount = "<%= Rails.application.routes.url_helpers.archangel_path %>";

    return mount.replace(/\/$/, "");
  }

  function adminScope() {
    return "<%= Archangel.configuration.auth_path %>";
  }

  function authScope() {
    return "<%= Archangel.configuration.auth_path %>";
  }

  // Translations
  object.translation = {};

  // Where the Rails engine is mounted
  object.mountedAt = function() {
    return mountScope();
  };

  // Archangel root path
  object.rootPath = function() {
    return pathBuilder(mountScope());
  };

  // Archangel admin root path
  object.adminPath = function() {
    return pathBuilder([mountScope(), adminScope()]);
  };

  // Archangel auth root path
  object.authPath = function() {
    return pathBuilder([mountScope(), authScope()]);
  };

  // Archangel route path
  object.pathFor = function(path, args) {
    var final_path,
        options = serialize(args || {});

    final_path = pathBuilder(path);

    // Query string
    if (options.length !== 0) {
      final_path = final_path + "?" + options;
    }

    return final_path.toString();
  };

  // Archangel admin route path
  object.adminPathFor = function(path, args) {
    return this.pathFor([adminScope(), path], args);
  };

  // Archangel auth route path
  object.authPathFor = function(path, args) {
    return this.pathFor([authScope(), path], args);
  };

  // Routes
  object.route = {
    home: object.rootPath(),
    root: object.rootPath(),
    admin: {
      root: object.adminPath()
    },
    auth: {
      root: object.authPath()
    },
    page: function(path) {
      return object.pathFor(path);
    }
  };

  return object;

}(Archangel || {}));
